---
import { SITE_TAB, SITE_DESCRIPTION, SITE_FAVICON, SITE_LANGUAGE, SITE_THEME, umamiConfig, SITE_PAGES } from "@config";
import { ClientRouter } from "astro:transitions";
import ElementCrossing from "astro-vtbot/components/ElementCrossing.astro";
import PointerOnNavigation from "astro-vtbot/components/PointerOnNavigation.astro";
import Header from "@components/Header.astro";
import Sidebar from "@components/Sidebar.astro";
import Footer from "@components/Footer.astro";
import Navbar from "@components/Navbar.astro";
import Banner from "@components/Banner.astro";
import MobileTOC from "@components/widgets/MobileTOC.astro";

const { title, image, headings = [], showTOC = false, isIndexed = true, isPostPage = false } = Astro.props;

// Ê†πÊçÆÂΩìÂâçË∑ØÂæÑ‰ªéÈÖçÁΩÆ‰∏≠Ëé∑Âèñ Banner ÂÜÖÂÆπ
const currentPath = Astro.url.pathname.replace("/", "") || "home";
const pageConfig = SITE_PAGES?.[currentPath];
const bannerTitle = pageConfig?.title || title || "";
const bannerSubtitle = pageConfig?.subtitle || "";
---

<!doctype html>
<html
  lang={SITE_LANGUAGE}
  style="background-color: var(--custom-page-bg)"
  data-theme={SITE_THEME.light}
  data-theme-type="light"
>
  <head>
    <ClientRouter />
    <ElementCrossing />
    <PointerOnNavigation />
    <Header description={SITE_DESCRIPTION} favicon={SITE_FAVICON} image={image} />
    <title>{`${title} - ${SITE_TAB}`}</title>

    <!-- UmamiÂàÜÊûêÔºàËá™Âª∫Ôºâ -->
    {
      umamiConfig.enable && (
        <script defer src={`${umamiConfig.baseUrl}/script.js`} data-website-id={umamiConfig.websiteId} />
      )
    }

    <script defer src="https://han.zsx815.top/tracker.min.js" data-website-id="ryu"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" />

    <!-- Microsoft Clarity -->
    <!-- <script type="text/javascript">
      (function (c, l, a, r, i, t, y) {
        c[a] =
          c[a] ||
          function () {
            (c[a].q = c[a].q || []).push(arguments);
          };
        t = l.createElement(r);
        t.async = 1;
        t.src = "https://www.clarity.ms/tag/" + i;
        y = l.getElementsByTagName(r)[0];
        y.parentNode.insertBefore(t, y);
      })(window, document, "clarity", "script", "skz108rus8");
    </script> -->

    <!-- ‰∏ªÈ¢òÁÆ°ÁêÜËÑöÊú¨ -->
    <script define:vars={{ SITE_THEME }} is:inline>
      (function () {
        const storedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        let theme;
        if (storedTheme) {
          theme = storedTheme;
        } else {
          theme = prefersDark ? SITE_THEME.dark : SITE_THEME.light;
          localStorage.setItem("theme", theme);
        }
        document.documentElement.setAttribute("data-theme", theme);
        const themeType = theme === SITE_THEME.dark ? "dark" : "light";
        document.documentElement.setAttribute("data-theme-type", themeType);
        window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
          if (!localStorage.getItem("theme")) {
            const newTheme = e.matches ? SITE_THEME.dark : SITE_THEME.light;
            document.documentElement.setAttribute("data-theme", newTheme);
            const newThemeType = e.matches ? "dark" : "light";
            document.documentElement.setAttribute("data-theme-type", newThemeType);
            localStorage.setItem("theme", newTheme);
          }
        });
      })();
    </script>

    <!-- ÂØºËà™ÁîüÂëΩÂë®ÊúüÂ§ÑÁêÜ -->
    <script is:inline>
      // ÂØºËà™Áä∂ÊÄÅË∑üË∏™
      let navigationInProgress = false;
      let navigationTimeout = null;

      // Ê∏ÖÈô§ÂØºËà™Ë∂ÖÊó∂
      function clearNavigationTimeout() {
        if (navigationTimeout) {
          clearTimeout(navigationTimeout);
          navigationTimeout = null;
        }
      }

      // ÂØºËà™ÂºÄÂßãÂ§ÑÁêÜ
      document.addEventListener("astro:before-preparation", (event) => {
        console.log("Navigation starting...");
        navigationInProgress = true;

        // ËÆæÁΩÆÂØºËà™Ë∂ÖÊó∂‰øùÊä§Ôºà5ÁßíÂêéÂº∫Âà∂ÂÆåÊàêÔºâ
        clearNavigationTimeout();
        navigationTimeout = setTimeout(() => {
          console.warn("Navigation timeout, forcing completion");
          navigationInProgress = false;
          // Âº∫Âà∂ÈöêËóèÂä†ËΩΩÂô®
          const loader = document.getElementById("globalLoader");
          if (loader) {
            loader.style.opacity = "0";
            setTimeout(() => loader.remove(), 300);
          }
        }, 5000);
      });

      // ÂØºËà™ÂÜÖÂÆπÂä†ËΩΩÂÆåÊàê
      document.addEventListener("astro:after-preparation", (event) => {
        console.log("Navigation content loaded...");
      });

      // ÂØºËà™ÂÆåÊàêÂ§ÑÁêÜ
      document.addEventListener("astro:page-load", () => {
        console.log("Page loaded");
        navigationInProgress = false;
        clearNavigationTimeout();

        // ÈáçÊñ∞ÂàùÂßãÂåñÂØºËà™ÈìæÊé•Â§ÑÁêÜ
        initializeNavigationLinks();
      });

      // ÂØºËà™ÈîôËØØÂ§ÑÁêÜ
      document.addEventListener("astro:navigation-error", (event) => {
        console.error("Navigation error:", event.error);
        navigationInProgress = false;
        clearNavigationTimeout();

        // ÈîôËØØÊó∂Âº∫Âà∂Âà∑Êñ∞È°µÈù¢
        if (confirm("ÂØºËà™Â§±Ë¥•ÔºåÊòØÂê¶Âà∑Êñ∞È°µÈù¢Ôºü")) {
          window.location.reload();
        }
      });

      // ÂàùÂßãÂåñÂØºËà™ÈìæÊé•Â§ÑÁêÜ
      function initializeNavigationLinks() {
        const links = document.querySelectorAll("a[href]");

        links.forEach((link) => {
          // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÈÅøÂÖçÈáçÂ§çÁªëÂÆöÔºâ
          const newLink = link.cloneNode(true);
          link.parentNode.replaceChild(newLink, link);

          newLink.addEventListener("click", (e) => {
            const currentUrl = window.location.href;
            const targetUrl = newLink.href;

            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂΩìÂâçÈ°µÈù¢ÈìæÊé•ÔºåÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
            if (targetUrl === currentUrl) {
              e.preventDefault();
              e.stopPropagation();
              console.log("Prevented navigation to current page");
              return;
            }

            // Â¶ÇÊûúÂØºËà™Ê≠£Âú®ËøõË°å‰∏≠ÔºåÈòªÊ≠¢ÈáçÂ§çÁÇπÂáª
            if (navigationInProgress) {
              e.preventDefault();
              e.stopPropagation();
              console.log("Navigation already in progress");
              return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ§ñÈÉ®ÈìæÊé•
            const isExternal = newLink.hostname !== window.location.hostname;
            const hasTargetBlank = newLink.target === "_blank";

            if (isExternal || hasTargetBlank) {
              // Â§ñÈÉ®ÈìæÊé•ÊàñÊñ∞Á™óÂè£ÈìæÊé•Ôºå‰∏çÂ§ÑÁêÜ
              return;
            }

            console.log("Allowing navigation to:", targetUrl);
          });
        });
      }

      // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
      document.addEventListener("DOMContentLoaded", () => {
        initializeNavigationLinks();
      });

      // Â§ÑÁêÜÊµèËßàÂô®ÂêéÈÄÄ/ÂâçËøõÊåâÈíÆ
      window.addEventListener("popstate", () => {
        if (navigationInProgress) {
          console.log("Browser navigation detected during transition");
          navigationInProgress = false;
          clearNavigationTimeout();
        }
      });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightbox2@2.11.4/dist/css/lightbox.min.css" />

    <!-- ÁßªÈô§‰∏äËæπË∑ùÔºåËÆ©Banner‰ªéÈ°∂ÈÉ®ÂºÄÂßã -->
  </head><body class="flex flex-col min-h-screen" {...isIndexed ? { "data-pagefind-body": true } : {}}>
    <!-- üöÄ Êñ∞Â¢ûÔºöÂÖ®Â±ÄÂä†ËΩΩÂä®Áîª -->
    <!-- <div
      id="globalLoader"
      class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-white dark:bg-neutral-900"
    > -->
      <!-- Â§¥ÂÉè -->
      <!-- <img src="/profile.png" id="loaderAvatar" class="w-20 h-20 rounded-full mb-4 animate-pulse" alt="loading" /> -->
      <!-- ËøõÂ∫¶Êù°ÂÆπÂô® -->
      <!-- <div class="w-56 h-2 bg-neutral-200 dark:bg-neutral-700 rounded-full overflow-hidden">
        <div id="loaderBar" class="h-full bg-accent rounded-full" style="width: 0%"></div>
      </div>
    </div> -->
    <Banner title={bannerTitle} subtitle={bannerSubtitle} />
    <Navbar />
    <div class="max-w-blog mx-auto w-full flex-grow">
      <div class="grid grid-cols-1 md:grid-cols-5 lg:grid-cols-4 gap-4 px-4 pb-4 h-full">
        <main class="col-span-1 md:col-span-4 lg:col-span-3 bg-transparent order-1 md:order-2 flex flex-col gap-4">
          <div class="flex-grow flex flex-col gap-4">
            <slot />
          </div>
          <Footer />
        </main>
        <aside class="col-span-1 bg-transparent order-2 md:order-1 md:top-4">
          <Sidebar headings={headings} showTOC={showTOC} />
          <slot name="sidebar" />
        </aside>
      </div>
    </div>

    <script is:inline defer src="https://han.zsx815.top/tracker.min.js" data-website-id="ryu"></script>

    <MobileTOC headings={headings} showTOC={showTOC} />

    <!-- <script is:inline>
      let barWidth = 0;
      const bar = document.getElementById("loaderBar");
      const loader = document.getElementById("globalLoader");
      let loaderInterval = null;

      // ÈáçÁΩÆÂä†ËΩΩÂô®Áä∂ÊÄÅ
      function resetLoader() {
        barWidth = 0;
        if (bar) bar.style.width = "0%";
      }

      // ÂêØÂä®Âä†ËΩΩÂô®Âä®Áîª
      function startLoader() {
        resetLoader();

        /* 1. 0 ‚Üí 90% ÂåÄÈÄüÂæÄÂâçË∑ë */
        loaderInterval = setInterval(() => {
          if (barWidth >= 90) {
            clearInterval(loaderInterval);
            return;
          }
          barWidth += Math.random() * 12 + 2;
          if (bar) bar.style.width = Math.min(barWidth, 90) + "%";
        }, 200);
      }

      // ÂÆåÊàêÂä†ËΩΩÂô®Âä®Áîª
      function completeLoader() {
        clearInterval(loaderInterval);

        /* ÂÖàË°•Âà∞ 100% */
        if (bar) bar.style.width = "100%";

        /* ËÆ©Áî®Êà∑ÁúãÊ∏Ö 100% ÂÜçÊ∑°Âá∫ */
        setTimeout(() => {
          if (!loader) return;
          loader.style.opacity = "0";
          loader.addEventListener(
            "transitionend",
            () => {
              loader.remove();
              resetLoader(); // ÈáçÁΩÆÁä∂ÊÄÅ‰ª•‰æø‰∏ãÊ¨°‰ΩøÁî®
            },
            { once: true },
          );
        }, 200);
      }

      // ÁõëÂê¨ Astro ÂØºËà™‰∫ã‰ª∂
      document.addEventListener("astro:before-preparation", () => {
        console.log("Navigation started - showing loader");
        // ÈáçÊñ∞ÂàõÂª∫Âä†ËΩΩÂô®ÂÖÉÁ¥†ÔºàÂ¶ÇÊûúÂ∑≤Ë¢´ÁßªÈô§Ôºâ
        if (!document.getElementById("globalLoader")) {
          const newLoader = document.createElement("div");
          newLoader.id = "globalLoader";
          newLoader.className =
            "fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-white dark:bg-neutral-900";
          newLoader.innerHTML = `
        <img src="/profile.png" id="loaderAvatar" class="w-20 h-20 rounded-full mb-4 animate-pulse" alt="loading" />
        <div class="w-56 h-2 bg-neutral-200 dark:bg-neutral-700 rounded-full overflow-hidden">
          <div id="loaderBar" class="h-full bg-accent rounded-full" style="width: 0%"></div>
        </div>
      `;
          document.body.appendChild(newLoader);
        }

        // ÊòæÁ§∫Âä†ËΩΩÂô®Âπ∂ÂºÄÂßãÂä®Áîª
        const loaderElement = document.getElementById("globalLoader");
        if (loaderElement) {
          loaderElement.style.opacity = "1";
          loaderElement.style.display = "flex";
          startLoader();
        }
      });

      // Áªü‰∏ÄÂú® astro:page-load ÈáåÊî∂Â∞æ
      document.addEventListener("astro:page-load", () => {
        console.log("Navigation completed - hiding loader");
        completeLoader();
      });

      // ÂÖúÂ∫ïÔºö‰∏á‰∏ÄÊ≤°ÂêØÁî® ClientRouter
      window.addEventListener(
        "load",
        () => {
          completeLoader();
        },
        { once: true },
      );
    </script>

    <!-- üöÄ ÈÅÆÁΩ©Ê∑°Âá∫ËøáÊ∏° -->
    <style is:inline>
      #globalLoader {
        transition: opacity 0.3s ease-out;
      }
    </style> -->

    <!-- ÂÖ®Â±ÄÊ®±Ëä±È£òËêΩÁâπÊïà -->
    <!-- <script is:inline>
      // sakura.js - ÊµèËßàÂô®ÂÖ®Â±ÄÊ®±Ëä±È£òËêΩÁâπÊïà
      (function () {
        function getRandom(option, config) {
          let ret, random;
          switch (option) {
            case "x":
              ret = Math.random() * window.innerWidth;
              break;
            case "y":
              ret = Math.random() * window.innerHeight;
              break;
            case "s":
              ret = config.size.min + Math.random() * (config.size.max - config.size.min);
              break;
            case "r":
              ret = Math.random() * 6;
              break;
            case "fnx":
              random =
                config.speed.horizontal.min +
                Math.random() * (config.speed.horizontal.max - config.speed.horizontal.min);
              ret = function (x, y) {
                return x + random;
              };
              break;
            case "fny":
              random =
                config.speed.vertical.min + Math.random() * (config.speed.vertical.max - config.speed.vertical.min);
              ret = function (x, y) {
                return y + random;
              };
              break;
            case "fnr":
              ret = function (r) {
                return r + config.speed.rotation;
              };
              break;
          }
          return ret;
        }
        function Sakura(x, y, s, r, fn, idx, img, limitArray, config) {
          this.x = x;
          this.y = y;
          this.s = s;
          this.r = r;
          this.fn = fn;
          this.idx = idx;
          this.img = img;
          this.limitArray = limitArray;
          this.config = config;
        }
        Sakura.prototype.draw = function (cxt) {
          cxt.save();
          cxt.translate(this.x, this.y);
          cxt.rotate(this.r);
          cxt.drawImage(this.img, 0, 0, 40 * this.s, 40 * this.s);
          cxt.restore();
        };
        Sakura.prototype.update = function () {
          this.x = this.fn.x(this.x, this.y);
          this.y = this.fn.y(this.y, this.y);
          this.r = this.fn.r(this.r);
          if (this.x > window.innerWidth || this.x < 0 || this.y > window.innerHeight || this.y < 0) {
            if (this.limitArray[this.idx] === -1) {
              this.resetPosition();
            } else if (this.limitArray[this.idx] > 0) {
              this.resetPosition();
              this.limitArray[this.idx]--;
            }
          }
        };
        Sakura.prototype.resetPosition = function () {
          this.r = getRandom("fnr", this.config);
          if (Math.random() > 0.4) {
            this.x = getRandom("x", this.config);
            this.y = 0;
            this.s = getRandom("s", this.config);
            this.r = getRandom("r", this.config);
          } else {
            this.x = window.innerWidth;
            this.y = getRandom("y", this.config);
            this.s = getRandom("s", this.config);
            this.r = getRandom("r", this.config);
          }
        };
        function SakuraList() {
          this.list = [];
        }
        SakuraList.prototype.push = function (sakura) {
          this.list.push(sakura);
        };
        SakuraList.prototype.update = function () {
          for (var i = 0, len = this.list.length; i < len; i++) {
            this.list[i].update();
          }
        };
        SakuraList.prototype.draw = function (cxt) {
          for (var i = 0, len = this.list.length; i < len; i++) {
            this.list[i].draw(cxt);
          }
        };
        function SakuraManager(config) {
          this.config = config;
          this.canvas = null;
          this.ctx = null;
          this.sakuraList = null;
          this.animationId = null;
          this.img = null;
          this.isRunning = false;
        }
        SakuraManager.prototype.init = function () {
          var self = this;
          if (!self.config.enable || self.isRunning) return;
          self.img = new window.Image();
          self.img.src = "/sakura.png";
          self.img.onload = function () {
            self.createCanvas();
            self.createSakuraList();
            self.startAnimation();
            self.isRunning = true;
          };
        };
        SakuraManager.prototype.createCanvas = function () {
          this.canvas = document.createElement("canvas");
          this.canvas.height = window.innerHeight;
          this.canvas.width = window.innerWidth;
          this.canvas.setAttribute(
            "style",
            "position: fixed; left: 0; top: 0; pointer-events: none; z-index: " + this.config.zIndex + ";",
          );
          this.canvas.setAttribute("id", "canvas_sakura");
          document.body.appendChild(this.canvas);
          this.ctx = this.canvas.getContext("2d");
          window.addEventListener("resize", this.handleResize.bind(this));
        };
        SakuraManager.prototype.createSakuraList = function () {
          if (!this.img || !this.ctx) return;
          this.sakuraList = new SakuraList();
          var limitArray = new Array(this.config.sakuraNum).fill(this.config.limitTimes);
          for (var i = 0; i < this.config.sakuraNum; i++) {
            var sakura = new Sakura(
              getRandom("x", this.config),
              getRandom("y", this.config),
              getRandom("s", this.config),
              getRandom("r", this.config),
              { x: getRandom("fnx", this.config), y: getRandom("fny", this.config), r: getRandom("fnr", this.config) },
              i,
              this.img,
              limitArray,
              this.config,
            );
            sakura.draw(this.ctx);
            this.sakuraList.push(sakura);
          }
        };
        SakuraManager.prototype.startAnimation = function () {
          if (!this.ctx || !this.canvas || !this.sakuraList) return;
          var self = this;
          function animate() {
            if (!self.ctx || !self.canvas || !self.sakuraList) return;
            self.ctx.clearRect(0, 0, self.canvas.width, self.canvas.height);
            self.sakuraList.update();
            self.sakuraList.draw(self.ctx);
            self.animationId = requestAnimationFrame(animate);
          }
          self.animationId = requestAnimationFrame(animate);
        };
        SakuraManager.prototype.handleResize = function () {
          if (this.canvas) {
            this.canvas.width = window.innerWidth;
            this.canvas.height = window.innerHeight;
          }
        };
        // ÂÖ®Â±ÄÂàùÂßãÂåñ
        window.initSakura = function (config) {
          if (!window.__sakuraManager) {
            window.__sakuraManager = new SakuraManager(config);
            window.__sakuraManager.init();
          } else {
            // ÁßªÈô§Êóßcanvas
            var oldCanvas = document.getElementById("canvas_sakura");
            if (oldCanvas) oldCanvas.remove();
            window.__sakuraManager = new SakuraManager(config);
            window.__sakuraManager.init();
          }
        };
      })();
      function runSakura() {
        const isMobile = window.innerWidth <= 768;
        window.initSakura &&
          window.initSakura({
            enable: true,
            sakuraNum: isMobile ? 10 : 30,
            limitTimes: -1,
            zIndex: 9999,
            size: { min: 0.6, max: 1.2 },
            speed: {
              horizontal: { min: -2, max: -0.5 },
              vertical: { min: 1.2, max: 2.2 },
              rotation: 0.01,
            },
          });
      }
      runSakura();
      window.addEventListener("resize", runSakura);
      document.addEventListener("astro:after-swap", () => {
        runSakura();
      });
    </script> -->

    <!-- ÂÖ∂‰ΩôËÑöÊú¨‰øùÊåÅ‰∏çÂèò -->
    <script define:vars={{ SITE_THEME }} is:inline>
      document.addEventListener("astro:after-swap", () => {
        const storedTheme = localStorage.getItem("theme");
        if (storedTheme) {
          document.documentElement.setAttribute("data-theme", storedTheme);
          const themeType = storedTheme === SITE_THEME.dark ? "dark" : "light";
          document.documentElement.setAttribute("data-theme-type", themeType);
        }
      });
    </script>

    <script is:inline>
      document.addEventListener("astro:page-load", () => {
        document.querySelectorAll(".btn-copy").forEach((button) => {
          button.addEventListener("click", async () => {
            const codeBlock = button.closest(".ryuchan-code");
            const code = codeBlock.querySelector("code").textContent;
            const copyIcon = button.querySelector(".ryuchan-code-toolbar-copy-icon");
            const successIcon = button.querySelector(".ryuchan-code-toolbar-copy-success");
            try {
              await navigator.clipboard.writeText(code);
              copyIcon.classList.add("hidden");
              successIcon.classList.remove("hidden");
              button.classList.add("copy-success");
              setTimeout(() => {
                copyIcon.classList.remove("hidden");
                successIcon.classList.add("hidden");
                button.classList.remove("copy-success");
              }, 2000);
            } catch (err) {
              console.error("Failed to copy:", err);
            }
          });
        });
      });
    </script>

    <style is:inline>
      .btn-copy {
        position: relative;
        overflow: hidden;
      }
      .copy-success {
        animation: pulse 0.5s ease-in-out;
      }
      .ryuchan-code-toolbar-copy-success svg {
        color: #10b981;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
    </style>

    <script is:inline src="https://cdn.jsdelivr.net/npm/lightbox2@2.11.4/dist/js/lightbox.min.js"></script>

    <!-- ÂØºËà™ÈôçÁ∫ßÂ§ÑÁêÜ -->
    <script is:inline>
      // È¶ñÊ¨°ËÆøÈóÆÊ£ÄÊµãÂíåÈôçÁ∫ßÂ§ÑÁêÜ
      (function () {
        const NAVIGATION_DEBUG = true; // Ë∞ÉËØïÊ®°ÂºèÔºåÁîü‰∫ßÁéØÂ¢ÉÂèØ‰ª•ËÆæ‰∏∫ false

        function log(...args) {
          if (NAVIGATION_DEBUG) {
            console.log("[Navigation Debug]", ...args);
          }
        }

        // Ê£ÄÊµãÊòØÂê¶ÊòØÈ¶ñÊ¨°ËÆøÈóÆ
        const isFirstVisit = !sessionStorage.getItem("ryuchan_visited");
        if (isFirstVisit) {
          sessionStorage.setItem("ryuchan_visited", "true");
          log("First visit detected");
        }

        // Ê£ÄÊµãÂØºËà™ÊòØÂê¶Âç°‰Ωè
        let navigationStartTime = 0;
        const NAVIGATION_TIMEOUT = 3000; // 3ÁßíÂØºËà™Ë∂ÖÊó∂

        document.addEventListener("astro:before-preparation", () => {
          navigationStartTime = Date.now();
          log("Navigation started at:", navigationStartTime);
        });

        document.addEventListener("astro:page-load", () => {
          const navigationTime = Date.now() - navigationStartTime;
          log("Navigation completed in:", navigationTime + "ms");

          // Â¶ÇÊûúÂØºËà™Êó∂Èó¥ÂºÇÂ∏∏ÈïøÔºåËÆ∞ÂΩïË≠¶Âëä
          if (navigationTime > NAVIGATION_TIMEOUT) {
            console.warn("Navigation took unusually long:", navigationTime + "ms");
          }
        });

        // Âº∫Âà∂ÂØºËà™ÂáΩÊï∞ÔºàÈôçÁ∫ßÂà∞‰º†ÁªüÂØºËà™Ôºâ
        function forceTraditionalNavigation(link) {
          log("Forcing traditional navigation to:", link.href);
          window.location.href = link.href;
        }

        // ‰∏∫ÊâÄÊúâÂØºËà™ÈìæÊé•Ê∑ªÂä†ÈôçÁ∫ßÂ§ÑÁêÜ
        function addFallbackNavigation() {
          const navLinks = document.querySelectorAll("nav a[href], .navbar a[href], .menu a[href]");

          navLinks.forEach((link) => {
            link.addEventListener("click", function (e) {
              const currentTime = Date.now();
              const timeSinceNavigationStart = currentTime - navigationStartTime;

              // Â¶ÇÊûúÂØºËà™ËøõË°å‰∏≠Ë∂ÖÊó∂ÔºåÂº∫Âà∂‰ΩøÁî®‰º†ÁªüÂØºËà™
              if (navigationStartTime > 0 && timeSinceNavigationStart > NAVIGATION_TIMEOUT) {
                log("Navigation timeout detected, using fallback");
                e.preventDefault();
                forceTraditionalNavigation(this);
                return;
              }

              // È¶ñÊ¨°ËÆøÈóÆÊó∂ÁöÑÁâπÊÆäÂ§ÑÁêÜ
              if (isFirstVisit && Math.random() > 0.5) {
                // 50% Ê¶ÇÁéáÂº∫Âà∂‰º†ÁªüÂØºËà™
                log("First visit fallback triggered");
                e.preventDefault();
                forceTraditionalNavigation(this);
              }
            });
          });
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊ∑ªÂä†ÈôçÁ∫ßÂ§ÑÁêÜ
        document.addEventListener("DOMContentLoaded", addFallbackNavigation);
        document.addEventListener("astro:page-load", addFallbackNavigation);

        log("Navigation fallback system initialized");
      })();
    </script>
  </body>
</html>
