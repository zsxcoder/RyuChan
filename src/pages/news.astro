---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Icon } from "astro-icon/components";
import MainCard from "@/components/MainCard.astro";
import Pagination from "@/components/widgets/Pagination.astro";
import type { Page } from "@interfaces/data";
import { XMLParser } from "fast-xml-parser";

/* 1. 显式声明返回类型 */
interface NewsItem {
  title: string;
  link: string;
  pubDate: Date;
  description: string;
  slug: string;
}

async function fetchNews(): Promise<NewsItem[]> {
  try {
    const res = await fetch("https://60s.kemeow.top/v2/60s/rss");
    const xml = await res.text();
    const parser = new XMLParser({ ignoreAttributes: false });
    const obj = parser.parse(xml);

    const items = obj.rss?.channel?.item ?? [];
    const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;

    return items
      .map((i: any) => ({
        title: i.title ?? "",
        link: i.link ?? "",
        pubDate: new Date(i.pubDate ?? 0),
        description: i.description ?? "",
        slug: new Date(i.pubDate ?? 0).toISOString().split("T")[0],
      }))
      .filter((n: NewsItem) => +n.pubDate >= weekAgo)
      .sort((a: NewsItem, b: NewsItem) => +b.pubDate - +a.pubDate);
  } catch (e) {
    console.error("RSS 抓取失败:", e);
    return [];
  }
}

const news = await fetchNews();

/* 2. 分页逻辑（同上，无改动） */
const currentPage = Math.max(1, parseInt(Astro.url.searchParams.get("page") || "1", 10));
const pageSize = 1;
const totalPages = Math.ceil(news.length / pageSize);
const startIdx = (currentPage - 1) * pageSize;
const pageNews = news.slice(startIdx, startIdx + pageSize);

const page: Page = {
  url: {
    prev: currentPage > 1 ? `/news?page=${currentPage - 1}` : undefined,
    next: currentPage < totalPages ? `/news?page=${currentPage + 1}` : undefined,
  },
  data: pageNews.map((n: NewsItem) => ({
    // ← 显式注解
    data: {
      title: n.title,
      description: n.description,
      pubDate: n.pubDate,
      image: "",
      badge: "",
      categories: [],
      tags: [],
    },
    remarkPluginFrontmatter: {
      totalCharCount: n.description.length.toString(),
      readingTime: "1 min",
    },
    slug: n.slug,
  })),
  total: news.length,
  size: pageSize,
  current: currentPage,
};

/* 页码生成（同上，无改动） */
const pageLinks = { active: [] as (string | number)[], hidden: [] as (string | number)[] };
if (totalPages <= 5) {
  pageLinks.active = Array.from({ length: totalPages }, (_, i) => i + 1);
} else {
  if (currentPage <= 3) {
    pageLinks.active = [1, 2, 3, 4, "...", totalPages];
  } else if (currentPage >= totalPages - 2) {
    pageLinks.active = [1, "...", totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
  } else {
    pageLinks.active = [1, "...", currentPage - 1, currentPage, currentPage + 1, "...", totalPages];
  }
  const allPages = Array.from({ length: totalPages }, (_, i) => i + 1);
  pageLinks.hidden = allPages.filter((p) => !pageLinks.active.includes(p));
}

const baseUrl = "/news";
---

<BaseLayout title="News">
  <MainCard
    title="每日新闻"
    description="最近一周的 60 秒新闻"
    textOverlay="NEWS"
    image="https://img.xiaozhangya.xin/file/1753261567796_bg1.jpg"
    infoIcon="lucide:newspaper"
  >
    <div class="space-y-6">
      {
        pageNews.length ? (
          pageNews.map(
            (
              n: NewsItem, // ← 显式注解
            ) => (
              <article class="card bg-base-200 shadow-lg">
                <div class="card-body">
                  <div class="flex justify-between items-start mb-4">
                    <h2 class="card-title text-2xl">
                      <a href={n.link} target="_blank" rel="noopener noreferrer" class="link link-hover">
                        {n.title}
                      </a>
                    </h2>
                    <div class="badge badge-primary">{n.pubDate.toLocaleDateString("zh-CN")}</div>
                  </div>

                  <div class="prose prose-base max-w-none" set:html={n.description} />

                  <div class="card-actions justify-end mt-4">
                    <a href={n.link} target="_blank" rel="noopener noreferrer" class="btn btn-primary btn-sm gap-2">
                      <Icon name="lucide:external-link" class="w-4 h-4" />
                      阅读全文
                    </a>
                  </div>
                </div>
              </article>
            ),
          )
        ) : (
          <div class="text-center py-12">
            <Icon name="lucide:newspaper" class="w-16 h-16 mx-auto mb-4 opacity-50" />
            <p class="text-lg opacity-75">暂无新闻数据</p>
          </div>
        )
      }

      {
        totalPages > 1 && (
          <div class="mt-8">
            <Pagination page={page} totalPages={totalPages} pageLinks={pageLinks} baseUrl={baseUrl} />
          </div>
        )
      }
    </div>
  </MainCard>
</BaseLayout>
