---
// src/components/widgets/Announcement.astro
import Card from "../temple/Card.astro";
import { marked } from "marked";
import DOMPurify from "dompurify"; // ä»…æµè§ˆå™¨ç«¯å¼•ç”¨

export interface Props {
  message?: string;
  enabled?: boolean;
}

const {
  message = `ğŸ‰ æ¬¢è¿æ¥åˆ°æˆ‘çš„**åšå®¢**ï¼Œè¿™é‡Œè®°å½•æˆ‘çš„ç”Ÿæ´»æ—¥å¸¸ã€è¸©å‘æ•™ç¨‹å’Œèµ„æºåˆ†äº«ï¼<br>å¦‚æœç½‘ç«™æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä¼˜å…ˆ<kbd>CTRL</kbd>+<kbd>F5</kbd>åˆ·æ–°ä¸€ä¸‹~<br>å¦‚æœæœ‰ä»€ä¹ˆå»ºè®®æˆ–è€…é—®é¢˜ï¼Œä¼˜å…ˆåœ¨<a href="mailto:me@mcyzsx.top" target="_blank" rel="noopener noreferrer">é‚®ç®±</a>æ‰¾æˆ‘ï¼`,
  enabled = true,
} = Astro.props;

/* å…è®¸ Markdown + HTML æ··å†™ */
marked.setOptions({ html: true });
const rawHtml = marked.parse(message); // ç”Ÿæˆ HTML
---

{
  enabled && message && (
    <Card>
      <div class="announcement-widget p-4">
        <div class="announcement-header mb-3">
          <h3 class="text-lg font-semibold flex items-center gap-2">
            <span class="text-xl">ğŸ“¢</span>
            <span>å…¬å‘Š</span>
          </h3>
        </div>

        <div class="announcement-content">
          <div class="speaker-icon">
            <>{/* <span class="speaker-emoji">ğŸ“¢</span> */}</>
          </div>
          {/* å®¢æˆ·ç«¯æ¸²æŸ“ï¼šå…ˆæ¶ˆæ¯’å†æ’å…¥ */}
          <div
            class="announcement-text"
            data-raw={rawHtml}
            set:html={typeof window !== "undefined" ? DOMPurify.sanitize(rawHtml, { ADD_TAGS: ["kbd"] }) : rawHtml}
          />
        </div>
      </div>
    </Card>
  )
}

<style lang="scss">
  /* æ ·å¼ä¸ä¹‹å‰å®Œå…¨ä¸€è‡´ï¼Œä¸å†é‡å¤ */
  .announcement-widget {
    .announcement-header {
      border-bottom: 1px solid rgba(var(--c-border-rgb), 0.1);
      padding-bottom: 0.75rem;
      h3 {
        color: var(--c-text-1);
        font-family: var(--font-primary);
      }
    }

    .announcement-content {
      display: flex;
      align-items: center;
      gap: 0.875rem;
      padding: 1rem;
      margin-top: 0.5rem;
      position: relative;
      border-radius: 0.75rem;
      background: rgba(var(--c-bg-soft-rgb), 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(var(--c-border-rgb), 0.12);
      transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);

      &::before {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(var(--c-primary-rgb), 0.08) 0%,
          rgba(var(--c-primary-rgb), 0.04) 50%,
          rgba(var(--c-primary-rgb), 0.06) 100%
        );
        opacity: 0;
        transition: opacity 0.4s ease;
        z-index: -1;
        border-radius: inherit;
      }

      &:hover {
        transform: translateY(-2px);
        &::before {
          opacity: 1;
        }
      }
    }

    .speaker-icon {
      flex-shrink: 0;
      z-index: 1;
      .speaker-emoji {
        font-size: 1.5rem;
        display: inline-block;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15)) drop-shadow(0 0 6px rgba(var(--c-primary-rgb), 0.25));
        animation: iconFloat 3s ease-in-out infinite;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
    }

    .announcement-text {
      flex: 1;
      text-align: center;
      font-weight: 550;
      color: var(--c-text-1);
      font-size: 0.925rem;
      line-height: 1.6;
      letter-spacing: 0.01em;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      animation: textPulse 3s ease-in-out infinite;
      transition: all 0.4s cubic-bezier(0.33, 1, 0.68, 1);
    }

    .announcement-content:hover {
      .speaker-icon .speaker-emoji {
        transform: scale(1.25);
        filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.25)) drop-shadow(0 0 16px rgba(var(--c-primary-rgb), 0.5));
        animation: iconPulse 1.5s ease-in-out infinite;
      }
      .announcement-text {
        color: var(--c-primary);
        text-shadow:
          0 1px 3px rgba(0, 0, 0, 0.15),
          0 0 12px rgba(var(--c-primary-rgb), 0.3),
          0 0 20px rgba(var(--c-primary-rgb), 0.2);
        animation: textHighlight 2s ease-in-out;
      }
    }

    .announcement-content {
      animation:
        slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards,
        contentFloat 6s ease-in-out infinite 0.6s;
    }
  }

  /* ===== keyframes ä¿æŒé¡¶çº§ ===== */
  @keyframes iconFloat {
    0%,
    100% {
      transform: translateY(0) scale(1) rotate(0deg);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15)) drop-shadow(0 0 6px rgba(var(--c-primary-rgb), 0.25));
    }
    33% {
      transform: translateY(-3px) scale(1.05) rotate(3deg);
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2)) drop-shadow(0 0 10px rgba(var(--c-primary-rgb), 0.4));
    }
    66% {
      transform: translateY(2px) scale(0.95) rotate(-2deg);
      filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.18)) drop-shadow(0 0 8px rgba(var(--c-primary-rgb), 0.3));
    }
  }

  @keyframes textPulse {
    0%,
    100% {
      color: var(--c-text-1);
      transform: scale(1);
      text-shadow:
        0 1px 2px rgba(0, 0, 0, 0.08),
        0 0 4px rgba(var(--c-primary-rgb), 0.1);
    }
    50% {
      color: var(--c-primary);
      transform: scale(1.02);
      text-shadow:
        0 2px 6px rgba(0, 0, 0, 0.12),
        0 0 12px rgba(var(--c-primary-rgb), 0.3),
        0 0 18px rgba(var(--c-primary-rgb), 0.2);
    }
  }

  @keyframes iconPulse {
    0%,
    100% {
      transform: scale(1.25) rotate(5deg);
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.25)) drop-shadow(0 0 16px rgba(var(--c-primary-rgb), 0.5));
    }
    50% {
      transform: scale(1.3) rotate(7deg);
      filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.3)) drop-shadow(0 0 20px rgba(var(--c-primary-rgb), 0.7));
    }
  }

  @keyframes textHighlight {
    0% {
      color: var(--c-text-1);
      transform: scale(1);
      text-shadow:
        0 1px 2px rgba(0, 0, 0, 0.08),
        0 0 4px rgba(var(--c-primary-rgb), 0.1);
    }
    100% {
      color: var(--c-primary);
      transform: scale(1.05);
      text-shadow:
        0 4px 12px rgba(0, 0, 0, 0.15),
        0 0 20px rgba(var(--c-primary-rgb), 0.4),
        0 0 30px rgba(var(--c-primary-rgb), 0.3);
    }
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
      filter: blur(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
      filter: blur(0);
    }
  }

  @keyframes contentFloat {
    0%,
    100% {
      transform: translateY(0) scale(1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(12px);
    }
    50% {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(16px);
    }
  }

  @media (max-width: 768px) {
    .announcement-widget .announcement-content {
      gap: 0.75rem;
      padding: 0.75rem;
      border-radius: 0.375rem;
    }
    .announcement-widget .speaker-icon .speaker-emoji {
      font-size: 1.25rem;
    }
    .announcement-widget .announcement-text {
      font-size: 0.875rem;
      line-height: 1.4;
    }
  }

  @media (max-width: 480px) {
    .announcement-widget .announcement-content {
      padding: 0.625rem;
      gap: 0.625rem;
      border-radius: 0.25rem;
    }
    .announcement-widget .speaker-icon .speaker-emoji {
      font-size: 1.125rem;
    }
    .announcement-widget .announcement-text {
      font-size: 0.825rem;
      line-height: 1.3;
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .announcement-widget {
      .announcement-content,
      .announcement-content:hover,
      .speaker-icon .speaker-emoji,
      .announcement-text {
        transition: none !important;
        animation: none !important;
      }
      .announcement-content:hover {
        transform: none;
      }
    }
  }
</style>
