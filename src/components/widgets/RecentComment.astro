---
/**
 * RecentComment.astro
 * 使用 GET 拉取 Waline 最新 5 条评论 | 点击滚动到对应楼层
 * 用法：<RecentComment serverURL="https://your-waline.vercel.app" />
 */
export interface Props {
  serverURL: string;
}

const { serverURL } = Astro.props;

/* ---------- 工具函数 ---------- */
const ADMIN_HASH = "252fb3ce94cd050b2ee835aca2b211b3";

function formatTimeAgo(ts: number): string {
  const diff = Math.floor((Date.now() - ts) / 1000);
  if (diff < 60) return "刚刚";
  if (diff < 3600) return `${Math.floor(diff / 60)} 分钟前`;
  if (diff < 86400) return `${Math.floor(diff / 3600)} 小时前`;
  if (diff < 604800) return `${Math.floor(diff / 86400)} 天前`;
  return new Intl.DateTimeFormat("zh-CN", { month: "numeric", day: "numeric" }).format(ts) + "日";
}

function formatContent(html = ""): string {
  if (!html) return "";
  return html
    .replace(/<pre><code[\s\S]*?<\/code><\/pre>/g, "[代码块]")
    .replace(/<code>([^<]{4,})<\/code>/g, "[代码]")
    .replace(/<code>([^<]{1,3})<\/code>/g, "$1")
    .replace(/<img(?![^>]*class=".*tk-owo-emotion")[^>]*>/g, "[图片]")
    .replace(/<a[^>]*>[\s\S]*?<\/a>/g, "[链接]")
    .replace(/<(?!\/?img[^>]*class=".*tk-owo-emotion")[^>]+>/g, "")
    .trim();
}

/* ---------- 获取数据 ---------- */
type Comment = {
  id: string;
  content: string;
  author: string;
  date: string;
  avatar: string;
  isAdmin: boolean;
  url: string;
};

let comments: Comment[] = [];
let error = false;

try {
  const res = await fetch(`${serverURL}/comment?type=recent&count=5`);
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  const data = await res.json();
  /* 仅开发环境打印日志 */
  if (import.meta.env.DEV) {
    console.log("[RecentComment] 拿到", data.length, "条", data);
  }

  comments = data.slice(0, 5).map((c: any) => ({
    id: c.objectId,
    content: formatContent(c.comment),
    author: c.nick,
    date: formatTimeAgo(new Date(c.insertedAt).getTime()),
    avatar: c.avatar.trim(),
    isAdmin: c.type === "administrator",
    url: c.url,
  }));
} catch (err) {
  console.error("[RecentComment] 请求失败", err);
  error = true;
}
---

<div class="comment-wrap">
  <ul class="comment-list">
    {
      error ? (
        <li class="state-box">评论加载失败，详见控制台</li>
      ) : comments.length === 0 ? (
        <li class="state-box">暂无评论</li>
      ) : (
        comments.map((c) => (
          <li class="comment-item" data-url={c.url} data-id={c.id}>
            <div class="meta">
              <div class="left">
                <img src={c.avatar} alt={c.author} class="avatar" />
                <span class="nick">{c.author}</span>
                {c.isAdmin && (
                  <svg class="badge" viewBox="0 0 24 24">
                    <path
                      fill="currentColor"
                      d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                    />
                  </svg>
                )}
              </div>
              <time class="date">{c.date}</time>
            </div>
            <p class="content" set:html={c.content} />
          </li>
        ))
      )
    }
  </ul>
</div>

<style lang="scss">
  .comment-wrap {
    min-height: 280px;
    padding: 0.6rem 0;
  }
  .state-box {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 220px;
    font-size: 0.9em;
    color: var(--c-text-2);
  }
  .comment-list {
    margin: 0;
    padding: 0;
    list-style: none;
  }
  .comment-item {
    padding: 0.75rem 0.6rem;
    border-radius: 8px;
    transition: background 0.2s;
    cursor: pointer;
    & + .comment-item {
      margin-top: 4px;
    }
    &:hover {
      background: var(--c-bg-soft);
    }
  }
  .meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 0.82em;
  }
  .left {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    object-fit: cover;
  }
  .nick {
    font-weight: 500;
    color: var(--c-text-1);
  }
  .badge {
    width: 1em;
    height: 1em;
    color: var(--c-primary);
  }
  .date {
    white-space: nowrap;
    color: var(--c-text-3);
  }
  .content {
    overflow: hidden;
    margin: 0;
    font-size: 0.9em;
    white-space: nowrap;
    text-overflow: ellipsis;
    color: var(--c-text-2);
    :global(img.tk-owo-emotion) {
      width: 16px;
      height: 16px;
      margin: 0 2px;
      vertical-align: text-bottom;
    }
  }
</style>

<script>
  document.querySelectorAll(".comment-item").forEach((el) => {
    const url = (el as HTMLElement).dataset.url;
    const id = (el as HTMLElement).dataset.id;
    if (!url || !id) return;
    el.addEventListener("click", () => {
      location.href = `${url}#waline-comment-${id}`;
    });
  });
</script>
