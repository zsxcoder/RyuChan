---
export interface Props {
  siteName: string;
  sitenick?: string;
  siteUrl: string;
  siteDesc?: string;
  siteIcon?: string;
  date?: string;
  upstream?: boolean;
  recommend?: boolean;
  qrcode?: string;
}

const {
  siteName,
  sitenick = siteName,
  siteUrl,
  siteDesc = "",
  siteIcon,
  date,
  upstream = false,
  recommend = false,
  qrcode = "",
} = Astro.props;

const showQR = qrcode && qrcode !== "";
---

<div class="friend-card" data-link={siteUrl}>
  <div class="punch"></div>
  <div class="status-tag" id={`status-${siteUrl.replace(/[^a-zA-Z0-9]/g, '')}`}></div>
  <header>
    <h3 class="title">{sitenick}</h3>
    {siteIcon && <img class="icon" src={siteIcon} alt={siteName} loading="lazy" />}
  </header>
  <main>
    <p class="author">{siteName}</p>
    <p class="desc">{siteDesc}</p>
  </main>
  {showQR && <img class="qrcode" src={qrcode} alt="qr" onclick={`window.__openQR('${qrcode}')`} />}
  <aside class="extras">
    {date && <time class="date">{date}</time>}
    {
      (upstream || recommend) && (
        <img
          class="corner"
          src={`https://cdn.atao.cyou/Web/${upstream ? "upstream" : "recommend"}.png`}
          alt={upstream ? "upstream" : "recommend"}
        />
      )
    }
  </aside>
  <a class="indicator" href={siteUrl} target="_blank" rel="noopener">
    <span>前往网站</span><span>→</span>
  </a>
</div>

<script>
  (window as any).__openQR = (src: string) => {
    const box = document.createElement("div");
    box.style.cssText = `position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:9999`;
    box.innerHTML = `
      <div style="background:#fff;padding:30px;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5)">
        <img src="${src}" style="width:280px;height:280px"/>
        <button onclick="this.closest('div').parentElement.remove()" style="position:absolute;top:8px;right:8px;width:32px;height:32px;border:none;background:#fff;border-radius:50%;font-size:20px;cursor:pointer">×</button>
      </div>`;
    document.body.appendChild(box);
  };

  function addStatusTagsWithCache(jsonUrl) {
    const cacheKey = "statusTagsData";
    const cacheExpirationTime = 30 * 60 * 1000; // 半小时
    
    function applyStatusTags(data) {
      const linkStatus = data.link_status;
      document.querySelectorAll('.friend-card').forEach(card => {
        const link = card.getAttribute('data-link');
        if (!link) return;
        
        const cleanLink = link.replace(/\/$/, '');
        const statusElement = card.querySelector('.status-tag');
        if (!statusElement) return;
        
        let matched = false;
        // 查找链接状态
        const status = linkStatus.find(item => item.link.replace(/\/$/, '') === cleanLink);
        
        if (status) {
          let latencyText = '检测中';
          let className = 'status-tag-red'; // 默认红色
          
          if (status.latency === -1) {
            latencyText = '未知';
          } else {
            latencyText = status.latency.toFixed(2) + 's';
            if (status.latency <= 2) {
              className = 'status-tag-green';
            } else if (status.latency <= 5) {
              className = 'status-tag-light-yellow';
            } else if (status.latency <= 10) {
              className = 'status-tag-dark-yellow';
            }
          }
          
          statusElement.textContent = latencyText;
          statusElement.classList.add(className);
          matched = true;
        }
        
        if (!matched) {
          statusElement.textContent = '检测中';
          statusElement.classList.add('status-tag-dark-yellow');
        }
      });
    }
    
    function fetchDataAndUpdateUI() {
      fetch(jsonUrl)
        .then(response => response.json())
        .then(data => {
          applyStatusTags(data);
          const cacheData = {
            data: data,
            timestamp: Date.now()
          };
          localStorage.setItem(cacheKey, JSON.stringify(cacheData));
        })
        .catch(error => {
          console.error('Error fetching test-flink result.json:', error);
          // 加载失败时显示默认状态
          document.querySelectorAll('.status-tag').forEach(tag => {
            tag.textContent = '未知';
            tag.classList.add('status-tag-red');
          });
        });
    }
    
    const cachedData = localStorage.getItem(cacheKey);
    if (cachedData) {
      const { data, timestamp } = JSON.parse(cachedData);
      if (Date.now() - timestamp < cacheExpirationTime) {
        applyStatusTags(data);
        return;
      }
    }
    fetchDataAndUpdateUI();
  }

  // 延迟执行，确保DOM已加载
  setTimeout(() => {
    addStatusTagsWithCache('https://check-flink.mcyzsx.top/result.json');
  }, 1000);
</script>

<style>
  /* ===============  纸纹共用  =============== */
  .friend-card {
    --w: 288px; /* 比原来略小，防止 320 minmax 在窄屏溢出 */
    --h: 210px;
    width: var(--w);
    height: var(--h);
    position: relative;
    padding: 18px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border-radius: 12px;

    background-color: var(--bg-soft);
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix values='0 0 0 0 .65 0 0 0 0 .62 0 0 0 0 .58 0 0 0 .25 0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    background-size: 240px;
    box-shadow:
      inset 0 0 0 1px var(--border),
      0 2px 4px -1px rgba(0, 0, 0, 0.06),
      0 4px 10px -2px rgba(0, 0, 0, 0.04);
    transition:
      transform 0.25s ease,
      box-shadow 0.25s ease;
  }
  .friend-card:hover {
    transform: translateY(-3px);
    box-shadow:
      inset 0 0 0 1px var(--border),
      0 6px 16px -2px rgba(0, 0, 0, 0.1),
      0 8px 24px -4px rgba(0, 0, 0, 0.06);
  }

  /* 深色纸 */
  html.dark .friend-card {
    background-color: var(--bg-base);
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3CfeColorMatrix values='0 0 0 0 .22 0 0 0 0 .22 0 0 0 0 .25 0 0 0 .15 0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
    box-shadow:
      inset 0 0 0 1px var(--border),
      0 4px 12px -1px rgba(0, 0, 0, 0.35),
      0 8px 24px -4px rgba(0, 0, 0, 0.2);
  }
  html.dark .friend-card:hover {
    box-shadow:
      inset 0 0 0 1px var(--border),
      0 8px 24px -1px rgba(0, 0, 0, 0.45),
      0 12px 32px -4px rgba(0, 0, 0, 0.25);
  }

  /* 状态标签样式 */
  .status-tag {
    position: absolute;
    top: 0px;
    left: 0px;
    padding: 3px 8px;
    border-radius: 12px 0px 12px 0px;
    font-size: 12px;
    color: white;
    font-weight: bold;
    transition: font-size 0.3s ease-out, width 0.3s ease-out, opacity 0.3s ease-out;
    z-index: 10;
  }
  .friend-card:hover .status-tag {
    font-size: 0px;
    opacity: 0;
  }
  /* 固态颜色 */
  .status-tag-green {
    background-color: #005E00; /* 绿色 */
  }
  .status-tag-light-yellow {
    background-color: #FED101; /* 浅黄色 */
  }
  .status-tag-dark-yellow {
    background-color: #F0B606; /* 深黄色 */
  }
  .status-tag-red {
    background-color: #B90000; /* 红色 */
  }

  /* 打孔 */
  .punch {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: transparent;
    box-shadow:
      inset 0 1px 2px rgba(0, 0, 0, 0.15),
      inset 0 -1px 1px rgba(255, 255, 255, 0.8),
      0 0 0 1px var(--border);
    pointer-events: none;
  }
  html.dark .punch {
    box-shadow:
      inset 0 1px 3px #000,
      inset 0 -1px 1px rgba(255, 255, 255, 0.05),
      0 0 0 1px var(--border);
  }

  /* 其余原样式仅做变量替换 */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 10px;
  }
  .title {
    font-size: 16px;
    font-weight: 600;
    color: var(--c-text);
    font-family: "ChillHuoSong_F", serif;
  }
  .icon {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    object-fit: cover;
  }
  main {
    flex: 1;
    min-height: 0;
  }
  .author {
    font-size: 15px;
    font-weight: 600;
    color: var(--c-text);
    margin: 0 0 4px;
  }
  .desc {
    font-size: 14px;
    color: var(--c-text-2);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .qrcode {
    position: absolute;
    bottom: 14px;
    left: 14px;
    width: 44px;
    height: 44px;
    border-radius: 6px;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .qrcode:hover {
    transform: scale(1.05);
  }
  .extras {
    position: absolute;
    bottom: 14px;
    right: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .date {
    font-size: 11px;
    color: var(--c-text-3);
    white-space: nowrap;
  }
  .corner {
    width: 56px;
    height: 56px;
    object-fit: contain;
    transform: rotate(-10deg);
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
  }
  html.dark .corner {
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.25));
  }
  .indicator {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%) translateY(6px);
    height: 18px;
    padding: 0 10px;
    background: rgba(100, 116, 139, 0.7);
    color: #f8fafc;
    border-radius: 6px;
    font-size: 10px;
    display: flex;
    align-items: center;
    gap: 4px;
    opacity: 0;
    transition: all 0.12s ease;
    pointer-events: none;
  }
  html.dark .indicator {
    background: rgba(148, 163, 184, 0.7);
    color: #0f172a;
  }
  a.indicator {
    pointer-events: auto;
  }
  .friend-card:hover .indicator {
    opacity: 0.8;
    transform: translateX(-50%) translateY(0);
  }
</style>
